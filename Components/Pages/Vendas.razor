@page "/vendas"
@using Controle_Roncatin.Models
@using Controle_Roncatin.Services
@inject DatabaseService Database

<h3><i class="bi bi-truck"></i> Registro de Vendas</h3>

<div class="row mt-4">
    <div class="col-md-4">
      <div class="card">
       <div class="card-header">
  <h5>Nova Venda</h5>
    </div>
      <div class="card-body">
    <EditForm Model="vendaSelecionada" OnValidSubmit="SalvarVenda">
     <DataAnnotationsValidator />

         <div class="mb-3">
            <label class="form-label">Metal *</label>
    <InputSelect class="form-control" @bind-Value="vendaSelecionada!.MetalId" @bind-Value:after="AtualizarPrecoSugerido">
  <option value="0">-- Selecione --</option>
     @if (metais != null)
      {
        @foreach (var metal in metais)
   {
         <option value="@metal.Id">@metal.Nome (@metal.UnidadeMedida)</option>
        }
       }
            </InputSelect>
        @if (estoqueDisponivel.HasValue)
        {
         <small class="text-muted">Estoque disponível: @estoqueDisponivel.Value.ToString("F2") @metalSelecionado?.UnidadeMedida</small>
        }
   </div>

     <div class="mb-3">
   <label class="form-label">Nome da Empresa/Cliente *</label>
<InputText class="form-control" @bind-Value="vendaSelecionada!.NomeCliente" placeholder="Razão social" />
      </div>

      <div class="mb-3">
     <label class="form-label">CNPJ</label>
   <InputText class="form-control" @bind-Value="vendaSelecionada!.CnpjCliente" placeholder="00.000.000/0000-00" />
      </div>

     <div class="row">
       <div class="col-md-6 mb-3">
        <label class="form-label">Telefone</label>
 <InputText class="form-control" @bind-Value="vendaSelecionada!.TelefoneCliente" placeholder="(00) 0000-0000" />
    </div>
      <div class="col-md-6 mb-3">
    <label class="form-label">Email</label>
     <InputText type="email" class="form-control" @bind-Value="vendaSelecionada!.EmailCliente" placeholder="contato@empresa.com" />
      </div>
 </div>

      <div class="mb-3">
    <label class="form-label">Quantidade/Peso *</label>
  <InputNumber class="form-control" @bind-Value="vendaSelecionada!.Quantidade" @bind-Value:after="CalcularTotal" step="0.01" />
  @if (metalSelecionado != null)
       {
       <small class="text-muted">Unidade: @metalSelecionado.UnidadeMedida</small>
 }
    @if (vendaSelecionada?.Quantidade > estoqueDisponivel)
   {
       <div class="text-danger small">?? Quantidade maior que estoque disponível!</div>
        }
     </div>

  <div class="mb-3">
              <label class="form-label">Preço Unitário (R$) *</label>
           <InputNumber class="form-control" @bind-Value="vendaSelecionada!.PrecoUnitario" @bind-Value:after="CalcularTotal" step="0.01" />
   @if (metalSelecionado != null && metalSelecionado.PrecoVenda > 0)
      {
   <small class="text-muted">Sugerido: R$ @metalSelecionado.PrecoVenda.ToString("F2")</small>
     }
      </div>

    <div class="mb-3">
         <label class="form-label">Valor Total</label>
      <div class="input-group">
   <span class="input-group-text">R$</span>
        <input type="text" class="form-control fw-bold" value="@vendaSelecionada!.ValorTotal.ToString("F2")" readonly />
     </div>
   </div>

    <div class="mb-3">
    <label class="form-label">Data/Hora da Venda *</label>
      <InputDate Type="InputDateType.DateTimeLocal" class="form-control" @bind-Value="vendaSelecionada!.DataVenda" />
      </div>

    <div class="mb-3">
    <label class="form-label">Número da NF</label>
  <InputText class="form-control" @bind-Value="vendaSelecionada!.NumeroNF" placeholder="Ex: 12345" />
     </div>

  <div class="mb-3">
    <label class="form-label">Status do Pagamento *</label>
  <InputSelect class="form-control" @bind-Value="vendaSelecionada!.StatusPagamento">
       <option value="Pendente">Pendente</option>
  <option value="Pago">Pago</option>
  <option value="Cancelado">Cancelado</option>
      </InputSelect>
 </div>

     <div class="mb-3">
  <label class="form-label">Observações</label>
   <InputTextArea class="form-control" @bind-Value="vendaSelecionada!.Observacoes" rows="2" placeholder="Informações adicionais..." />
      </div>

        <div class="d-grid gap-2">
         <button type="submit" class="btn btn-primary">
  <i class="bi bi-check-circle"></i> Registrar Venda
        </button>
   @if (vendaSelecionada?.Id > 0)
        {
       <button type="button" class="btn btn-secondary" @onclick="NovaVenda">
  <i class="bi bi-plus-circle"></i> Nova Venda
          </button>
      }
          </div>
  </EditForm>
  </div>
        </div>
    </div>

    <div class="col-md-8">
 <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
 <h5>Histórico de Vendas (Últimos 30 dias)</h5>
<button class="btn btn-sm btn-primary" @onclick="CarregarVendas">
  <i class="bi bi-arrow-clockwise"></i>
   </button>
 </div>
            <div class="card-body">
 @if (vendas == null)
            {
    <p class="text-center"><em>Carregando...</em></p>
        }
      else if (!vendas.Any())
   {
        <p class="text-center text-muted">Nenhuma venda registrada.</p>
  }
            else
    {
       <div class="alert alert-success">
   <strong>Total do Período:</strong> R$ @vendas.Sum(v => v.ValorTotal).ToString("F2")
    <span class="ms-3"><strong>Quantidade de Vendas:</strong> @vendas.Count</span>
       <span class="ms-3"><strong>Vendas Pagas:</strong> @vendas.Count(v => v.StatusPagamento == "Pago")</span>
          </div>

        <div class="table-responsive">
        <table class="table table-hover">
  <thead>
       <tr>
  <th>Data</th>
            <th>Metal</th>
    <th>Cliente</th>
       <th class="text-end">Quantidade</th>
          <th class="text-end">Preço Unit.</th>
        <th class="text-end">Total</th>
      <th>Pagamento</th>
              <th class="text-center">Ações</th>
   </tr>
      </thead>
              <tbody>
            @foreach (var venda in vendas)
       {
   <tr>
  <td>@venda.DataVenda.ToString("dd/MM/yyyy HH:mm")</td>
  <td><strong>@venda.Metal?.Nome</strong></td>
     <td>
  @venda.NomeCliente
        @if (!string.IsNullOrEmpty(venda.CnpjCliente))
  {
        <br /><small class="text-muted">CNPJ: @venda.CnpjCliente</small>
       }
    @if (!string.IsNullOrEmpty(venda.NumeroNF))
        {
    <br /><small class="text-muted">NF: @venda.NumeroNF</small>
    }
 </td>
      <td class="text-end">@venda.Quantidade.ToString("F2") @venda.Metal?.UnidadeMedida</td>
    <td class="text-end">R$ @venda.PrecoUnitario.ToString("F2")</td>
  <td class="text-end fw-bold">R$ @venda.ValorTotal.ToString("F2")</td>
     <td>
      <span class="badge @GetStatusPagamentoBadge(venda.StatusPagamento)">
          @venda.StatusPagamento
        </span>
    </td>
       <td class="text-center">
   <button class="btn btn-sm btn-outline-danger" @onclick="() => ExcluirVenda(venda)">
         <i class="bi bi-trash"></i>
       </button>
       </td>
    </tr>
        }
   </tbody>
        </table>
   </div>
            }
     </div>
        </div>
    </div>
</div>

@code {
    private List<Metal>? metais;
    private List<Venda>? vendas;
    private Venda? vendaSelecionada = new Venda();
    private Metal? metalSelecionado;
    private decimal? estoqueDisponivel;
    
    private DateTime? dataInicio = DateTime.Now.AddDays(-30);
    private DateTime? dataFim = DateTime.Now;

    protected override async Task OnInitializedAsync()
{
  await CarregarMetais();
   await CarregarVendas();
 }

    private async Task CarregarMetais()
   {
metais = await Database.GetMetaisAsync();
   }

    private async Task CarregarVendas()
    {
        vendas = await Database.GetVendasAsync(dataInicio, dataFim);
    }

    private async Task AtualizarPrecoSugerido()
    {
     if (vendaSelecionada != null && vendaSelecionada.MetalId > 0)
        {
     metalSelecionado = await Database.GetMetalAsync(vendaSelecionada.MetalId);
    estoqueDisponivel = await Database.GetSaldoAtualAsync(vendaSelecionada.MetalId);
   
     if (metalSelecionado != null)
        {
     vendaSelecionada.PrecoUnitario = metalSelecionado.PrecoVenda;
      CalcularTotal();
        }
    }
    }

    private void CalcularTotal()
    {
  if (vendaSelecionada != null)
        {
    vendaSelecionada.ValorTotal = vendaSelecionada.Quantidade * vendaSelecionada.PrecoUnitario;
     }
    }

    private async Task SalvarVenda()
    {
   if (vendaSelecionada != null && vendaSelecionada.MetalId > 0)
      {
  // Validar estoque
     if (vendaSelecionada.Quantidade > estoqueDisponivel)
       {
  // Em produção, mostrar um modal ou toast de erro
    return;
  }

  await Database.SaveVendaAsync(vendaSelecionada);
     await CarregarVendas();
  NovaVenda();
   }
    }

    private async Task ExcluirVenda(Venda venda)
{
  if (venda != null)
     {
  await Database.DeleteVendaAsync(venda);
       await CarregarVendas();
        }
    }

  private void NovaVenda()
  {
        vendaSelecionada = new Venda { DataVenda = DateTime.Now, StatusPagamento = "Pendente" };
    metalSelecionado = null;
        estoqueDisponivel = null;
    }

    private string GetStatusPagamentoBadge(string status)
    {
     return status switch
  {
      "Pago" => "bg-success",
     "Pendente" => "bg-warning text-dark",
  "Cancelado" => "bg-danger",
            _ => "bg-secondary"
  };
    }
}
