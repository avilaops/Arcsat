@page "/estoque"
@using Controle_Roncatin.Models
@using Controle_Roncatin.Services
@inject DatabaseService Database

<h3><i class="bi bi-boxes"></i> Controle de Estoque</h3>

<div class="row mt-4">
    <div class="col-md-12">
 <div class="card">
     <div class="card-header d-flex justify-content-between align-items-center">
       <h5>Estoque Atual</h5>
   <button class="btn btn-sm btn-primary" @onclick="CarregarEstoque">
  <i class="bi bi-arrow-clockwise"></i> Atualizar
     </button>
            </div>
     <div class="card-body">
        @if (estoque == null)
     {
       <p class="text-center"><em>Carregando...</em></p>
      }
     else if (!estoque.Any())
    {
   <p class="text-center text-muted">Nenhum metal em estoque.</p>
       }
else
   {
  <div class="row mb-3">
            <div class="col-md-3">
      <div class="card text-white bg-primary">
  <div class="card-body">
        <h6 class="card-title">Total de Itens</h6>
   <h3>@estoque.Count</h3>
       </div>
    </div>
      </div>
  <div class="col-md-3">
    <div class="card text-white bg-success">
         <div class="card-body">
    <h6 class="card-title">Valor Total em Estoque</h6>
    <h3>R$ @estoque.Sum(e => e.ValorEstoque).ToString("F2")</h3>
  </div>
   </div>
         </div>
     <div class="col-md-3">
        <div class="card text-white bg-warning">
  <div class="card-body">
        <h6 class="card-title">Alertas de Estoque Baixo</h6>
      <h3>@estoque.Count(e => e.AbaixoMinimo)</h3>
    </div>
      </div>
    </div>
  <div class="col-md-3">
    <div class="card text-white bg-info">
     <div class="card-body">
          <h6 class="card-title">Quantidade Total</h6>
    <h3>@estoque.Sum(e => e.QuantidadeAtual).ToString("F2")</h3>
  </div>
  </div>
     </div>
       </div>

 @if (estoque.Any(e => e.AbaixoMinimo))
     {
       <div class="alert alert-warning">
    <strong><i class="bi bi-exclamation-triangle"></i> Atenção!</strong> 
 @estoque.Count(e => e.AbaixoMinimo) item(ns) com estoque abaixo do mínimo.
      </div>
     }

     <div class="table-responsive">
   <table class="table table-hover">
    <thead>
       <tr>
       <th>Metal</th>
     <th class="text-end">Quantidade Atual</th>
     <th class="text-end">Estoque Mínimo</th>
    <th class="text-end">Preço Compra</th>
 <th class="text-end">Preço Venda</th>
    <th class="text-end">Valor em Estoque</th>
    <th>Status</th>
 <th class="text-center">Ações</th>
   </tr>
      </thead>
         <tbody>
   @foreach (var item in estoque.OrderBy(e => e.NomeMetal))
   {
    <tr class="@(item.AbaixoMinimo ? "table-warning" : "")">
         <td><strong>@item.NomeMetal</strong></td>
        <td class="text-end">
        @item.QuantidadeAtual.ToString("F2") @item.UnidadeMedida
     @if (item.AbaixoMinimo)
   {
       <i class="bi bi-exclamation-triangle text-warning ms-1" title="Abaixo do mínimo"></i>
    }
   </td>
        <td class="text-end">@item.EstoqueMinimo.ToString("F2") @item.UnidadeMedida</td>
    <td class="text-end">R$ @item.PrecoCompraAtual.ToString("F2")</td>
<td class="text-end">R$ @item.PrecoVendaAtual.ToString("F2")</td>
<td class="text-end fw-bold">R$ @item.ValorEstoque.ToString("F2")</td>
  <td>
  @if (item.QuantidadeAtual == 0)
  {
             <span class="badge bg-secondary">Zerado</span>
  }
    else if (item.AbaixoMinimo)
 {
   <span class="badge bg-warning text-dark">Baixo</span>
       }
     else
      {
     <span class="badge bg-success">OK</span>
   }
  </td>
 <td class="text-center">
  <button class="btn btn-sm btn-outline-info" @onclick="() => VerMovimentacoes(item.MetalId)">
      <i class="bi bi-clock-history"></i>
       </button>
    </td>
    </tr>
          }
     </tbody>
   </table>
     </div>
     }
   </div>
  </div>
    </div>
</div>

@if (movimentacoesSelecionadas != null)
{
    <div class="row mt-4">
 <div class="col-md-12">
     <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
     <h5>Movimentações - @metalMovimentacoes?.Nome</h5>
 <button class="btn btn-sm btn-secondary" @onclick="FecharMovimentacoes">
        <i class="bi bi-x-circle"></i> Fechar
    </button>
       </div>
            <div class="card-body">
        @if (!movimentacoesSelecionadas.Any())
      {
     <p class="text-center text-muted">Nenhuma movimentação registrada.</p>
}
     else
        {
   <div class="table-responsive">
      <table class="table table-sm table-striped">
        <thead>
     <tr>
    <th>Data/Hora</th>
       <th>Tipo</th>
    <th class="text-end">Quantidade</th>
<th class="text-end">Saldo Anterior</th>
  <th class="text-end">Saldo Atual</th>
   <th>Observações</th>
        </tr>
           </thead>
     <tbody>
  @foreach (var mov in movimentacoesSelecionadas)
        {
   <tr>
   <td>@mov.DataMovimentacao.ToString("dd/MM/yyyy HH:mm:ss")</td>
    <td>
      <span class="badge @GetTipoMovimentacaoBadge(mov.TipoMovimentacao)">
  @mov.TipoMovimentacao
    </span>
    </td>
 <td class="text-end @(mov.Quantidade > 0 ? "text-success" : "text-danger")">
     @mov.Quantidade.ToString("+0.00;-0.00") @metalMovimentacoes?.UnidadeMedida
      </td>
    <td class="text-end">@mov.SaldoAnterior.ToString("F2")</td>
    <td class="text-end fw-bold">@mov.SaldoAtual.ToString("F2")</td>
         <td>@mov.Observacoes</td>
       </tr>
       }
 </tbody>
    </table>
        </div>
       }
    </div>
  </div>
    </div>
    </div>
}

@code {
    private List<EstoqueAtual>? estoque;
    private List<MovimentacaoEstoque>? movimentacoesSelecionadas;
    private Metal? metalMovimentacoes;

    protected override async Task OnInitializedAsync()
 {
        await CarregarEstoque();
    }

    private async Task CarregarEstoque()
    {
        estoque = await Database.GetEstoqueAtualAsync();
    }

  private async Task VerMovimentacoes(int metalId)
    {
        metalMovimentacoes = await Database.GetMetalAsync(metalId);
        movimentacoesSelecionadas = await Database.GetMovimentacoesAsync(metalId);
    }

    private void FecharMovimentacoes()
    {
        movimentacoesSelecionadas = null;
  metalMovimentacoes = null;
    }

    private string GetTipoMovimentacaoBadge(string tipo)
    {
        return tipo switch
        {
    "COMPRA" => "bg-success",
    "VENDA" => "bg-primary",
            "AJUSTE" => "bg-warning text-dark",
     _ => "bg-secondary"
        };
    }
}
