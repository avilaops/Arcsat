@page "/compras"
@using Controle_Roncatin.Models
@using Controle_Roncatin.Services
@inject DatabaseService Database

<h3><i class="bi bi-cart-plus"></i> Registro de Compras</h3>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
          <h5>Nova Compra</h5>
            </div>
          <div class="card-body">
            <EditForm Model="compraSelecionada" OnValidSubmit="SalvarCompra">
         <DataAnnotationsValidator />

    <div class="mb-3">
            <label class="form-label">Metal *</label>
          <InputSelect class="form-control" @bind-Value="compraSelecionada!.MetalId" @bind-Value:after="AtualizarPrecoSugerido">
  <option value="0">-- Selecione --</option>
        @if (metais != null)
        {
        @foreach (var metal in metais)
     {
         <option value="@metal.Id">@metal.Nome (@metal.UnidadeMedida)</option>
      }
        }
             </InputSelect>
          </div>

      <div class="mb-3">
     <label class="form-label">Nome do Catador/Fornecedor *</label>
         <InputText class="form-control" @bind-Value="compraSelecionada!.NomeFornecedor" placeholder="Nome completo" />
         </div>

  <div class="mb-3">
    <label class="form-label">Documento (CPF/RG)</label>
      <InputText class="form-control" @bind-Value="compraSelecionada!.DocumentoFornecedor" placeholder="000.000.000-00" />
         </div>

                    <div class="mb-3">
  <label class="form-label">Telefone</label>
      <InputText class="form-control" @bind-Value="compraSelecionada!.TelefoneFornecedor" placeholder="(00) 00000-0000" />
       </div>

             <div class="mb-3">
             <label class="form-label">Quantidade/Peso *</label>
            <InputNumber class="form-control" @bind-Value="compraSelecionada!.Quantidade" @bind-Value:after="CalcularTotal" step="0.01" />
 @if (metalSelecionado != null)
    {
          <small class="text-muted">Unidade: @metalSelecionado.UnidadeMedida</small>
     }
   </div>

         <div class="mb-3">
   <label class="form-label">Preço Unitário (R$) *</label>
  <InputNumber class="form-control" @bind-Value="compraSelecionada!.PrecoUnitario" @bind-Value:after="CalcularTotal" step="0.01" />
         @if (metalSelecionado != null && metalSelecionado.PrecoCompra > 0)
              {
    <small class="text-muted">Sugerido: R$ @metalSelecionado.PrecoCompra.ToString("F2")</small>
     }
              </div>

        <div class="mb-3">
            <label class="form-label">Valor Total</label>
          <div class="input-group">
              <span class="input-group-text">R$</span>
      <input type="text" class="form-control fw-bold" value="@compraSelecionada!.ValorTotal.ToString("F2")" readonly />
  </div>
 </div>

             <div class="mb-3">
 <label class="form-label">Data/Hora da Compra *</label>
  <InputDate Type="InputDateType.DateTimeLocal" class="form-control" @bind-Value="compraSelecionada!.DataCompra" />
     </div>

      <div class="mb-3">
                 <label class="form-label">Observações</label>
      <InputTextArea class="form-control" @bind-Value="compraSelecionada!.Observacoes" rows="2" placeholder="Informações adicionais..." />
      </div>

        <div class="d-grid gap-2">
     <button type="submit" class="btn btn-success">
      <i class="bi bi-check-circle"></i> Registrar Compra
       </button>
           @if (compraSelecionada?.Id > 0)
          {
       <button type="button" class="btn btn-secondary" @onclick="NovaCompra">
                  <i class="bi bi-plus-circle"></i> Nova Compra
 </button>
        }
   </div>
     </EditForm>
       </div>
        </div>
    </div>

    <div class="col-md-8">
      <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
   <h5>Histórico de Compras (Últimos 30 dias)</h5>
   <button class="btn btn-sm btn-primary" @onclick="CarregarCompras">
   <i class="bi bi-arrow-clockwise"></i>
   </button>
       </div>
     <div class="card-body">
        @if (compras == null)
     {
      <p class="text-center"><em>Carregando...</em></p>
         }
            else if (!compras.Any())
            {
          <p class="text-center text-muted">Nenhuma compra registrada.</p>
    }
          else
                {
    <div class="alert alert-info">
    <strong>Total do Período:</strong> R$ @compras.Sum(c => c.ValorTotal).ToString("F2")
  <span class="ms-3"><strong>Quantidade de Compras:</strong> @compras.Count</span>
        </div>

   <div class="table-responsive">
      <table class="table table-hover">
    <thead>
 <tr>
           <th>Data</th>
 <th>Metal</th>
           <th>Fornecedor</th>
     <th class="text-end">Quantidade</th>
    <th class="text-end">Preço Unit.</th>
      <th class="text-end">Total</th>
   <th class="text-center">Ações</th>
       </tr>
            </thead>
              <tbody>
           @foreach (var compra in compras)
    {
          <tr>
          <td>@compra.DataCompra.ToString("dd/MM/yyyy HH:mm")</td>
         <td><strong>@compra.Metal?.Nome</strong></td>
   <td>
    @compra.NomeFornecedor
     @if (!string.IsNullOrEmpty(compra.TelefoneFornecedor))
       {
   <br /><small class="text-muted">@compra.TelefoneFornecedor</small>
         }
          </td>
             <td class="text-end">@compra.Quantidade.ToString("F2") @compra.Metal?.UnidadeMedida</td>
              <td class="text-end">R$ @compra.PrecoUnitario.ToString("F2")</td>
       <td class="text-end fw-bold">R$ @compra.ValorTotal.ToString("F2")</td>
    <td class="text-center">
                 <button class="btn btn-sm btn-outline-danger" @onclick="() => ExcluirCompra(compra)">
   <i class="bi bi-trash"></i>
     </button>
            </td>
        </tr>
           }
     </tbody>
        </table>
    </div>
      }
</div>
    </div>
    </div>
</div>

@code {
    private List<Metal>? metais;
    private List<Compra>? compras;
    private Compra? compraSelecionada = new Compra();
    private Metal? metalSelecionado;
    
    private DateTime? dataInicio = DateTime.Now.AddDays(-30);
    private DateTime? dataFim = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        await CarregarMetais();
  await CarregarCompras();
    }

    private async Task CarregarMetais()
    {
        metais = await Database.GetMetaisAsync();
    }

    private async Task CarregarCompras()
    {
        compras = await Database.GetComprasAsync(dataInicio, dataFim);
    }

    private async Task AtualizarPrecoSugerido()
    {
   if (compraSelecionada != null && compraSelecionada.MetalId > 0)
     {
  metalSelecionado = await Database.GetMetalAsync(compraSelecionada.MetalId);
            if (metalSelecionado != null)
     {
     compraSelecionada.PrecoUnitario = metalSelecionado.PrecoCompra;
    CalcularTotal();
        }
        }
    }

    private void CalcularTotal()
    {
        if (compraSelecionada != null)
  {
    compraSelecionada.ValorTotal = compraSelecionada.Quantidade * compraSelecionada.PrecoUnitario;
      }
    }

    private async Task SalvarCompra()
    {
        if (compraSelecionada != null && compraSelecionada.MetalId > 0)
        {
      await Database.SaveCompraAsync(compraSelecionada);
 await CarregarCompras();
  NovaCompra();
   }
    }

    private async Task ExcluirCompra(Compra compra)
    {
        if (compra != null)
    {
     await Database.DeleteCompraAsync(compra);
     await CarregarCompras();
  }
    }

    private void NovaCompra()
    {
        compraSelecionada = new Compra { DataCompra = DateTime.Now };
        metalSelecionado = null;
    }
}
