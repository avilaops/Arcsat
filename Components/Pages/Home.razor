@page "/"
@using Controle_Roncatin.Models
@using Controle_Roncatin.Services
@inject DatabaseService Database

<PageTitle>Dashboard - Controle Roncatin</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
<div>
      <button class="btn btn-primary" @onclick="CarregarDados">
 <i class="bi bi-arrow-clockwise"></i> Atualizar (Últimos 30 dias)
      </button>
  </div>
</div>

@if (carregando)
{
  <div class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>
}
else
{
    <!-- Resumo Financeiro -->
    <div class="row mb-4">
     <div class="col-md-3">
<div class="card text-white bg-success">
<div class="card-body">
           <div class="d-flex justify-content-between align-items-center">
         <div>
     <h6 class="card-title mb-0">Total Vendas</h6>
       <h3 class="mb-0">R$ @totalVendas.ToString("F2")</h3>
          <small>@quantidadeVendas vendas</small>
         </div>
     <i class="bi bi-cash-coin" style="font-size: 3rem, opacity: 0.3;"></i>
       </div>
     </div>
    </div>
   </div>
     <div class="col-md-3">
    <div class="card text-white bg-danger">
                <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
       <h6 class="card-title mb-0">Total Compras</h6>
                <h3 class="mb-0">R$ @totalCompras.ToString("F2")</h3>
 <small>@quantidadeCompras compras</small>
           </div>
         <i class="bi bi-cart-plus" style="font-size: 3rem, opacity: 0.3;"></i>
            </div>
       </div>
</div>
      </div>
        <div class="col-md-3">
         <div class="card text-white bg-primary">
           <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
  <div>
    <h6 class="card-title mb-0">Lucro Bruto</h6>
               <h3 class="mb-0">R$ @lucroBruto.ToString("F2")</h3>
               <small>@margemLucro.ToString("F2")% margem</small>
        </div>
  <i class="bi bi-graph-up-arrow" style="font-size: 3rem, opacity: 0.3;"></i>
         </div>
    </div>
            </div>
        </div>
        <div class="col-md-3">
<div class="card text-white bg-info">
              <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                <div>
         <h6 class="card-title mb-0">Valor em Estoque</h6>
 <h3 class="mb-0">R$ @valorEstoque.ToString("F2")</h3>
         <small>@quantidadeItensEstoque itens</small>
            </div>
              <i class="bi bi-boxes" style="font-size: 3rem, opacity: 0.3;"></i>
             </div>
</div>
 </div>
        </div>
    </div>

    <!-- Alertas -->
    @if (itensEstoqueBaixo > 0)
    {
        <div class="alert alert-warning mb-4">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Atenção!</strong> @itensEstoqueBaixo item(ns) com estoque abaixo do mínimo. 
          <a href="/estoque" class="alert-link">Ver estoque</a>
    </div>
  }

    <div class="row">
  <!-- Top 5 Metais Mais Vendidos -->
        <div class="col-md-6 mb-4">
            <div class="card">
       <div class="card-header">
 <h5><i class="bi bi-trophy"></i> Top 5 Metais Mais Vendidos</h5>
     </div>
    <div class="card-body">
      @if (vendas != null && vendas.Any())
           {
          var topVendidos = vendas
   .GroupBy(v => new { v.MetalId, v.Metal?.Nome, v.Metal?.UnidadeMedida })
 .Select(g => new {
     Nome = g.Key.Nome,
         UnidadeMedida = g.Key.UnidadeMedida,
 Quantidade = g.Sum(v => v.Quantidade),
 ValorTotal = g.Sum(v => v.ValorTotal)
               })
          .OrderByDescending(x => x.Quantidade)
            .Take(5)
           .ToList();

     <div class="list-group">
          @foreach (var item in topVendidos)
      {
      <div class="list-group-item">
         <div class="d-flex justify-content-between align-items-center">
            <div>
        <strong>@item.Nome</strong><br />
      <small class="text-muted">@item.Quantidade.ToString("F2") @item.UnidadeMedida</small>
 </div>
         <span class="badge bg-success">R$ @item.ValorTotal.ToString("F2")</span>
       </div>
            </div>
              }
           </div>
            }
      else
           {
  <p class="text-muted text-center">Nenhuma venda no período.</p>
             }
            </div>
      </div>
        </div>

        <!-- Top 5 Metais Mais Comprados -->
        <div class="col-md-6 mb-4">
            <div class="card">
       <div class="card-header">
      <h5><i class="bi bi-cart-check"></i> Top 5 Metais Mais Comprados</h5>
                </div>
         <div class="card-body">
    @if (compras != null && compras.Any())
    {
   var topComprados = compras
        .GroupBy(c => new { c.MetalId, c.Metal?.Nome, c.Metal?.UnidadeMedida })
   .Select(g => new {
        Nome = g.Key.Nome,
 UnidadeMedida = g.Key.UnidadeMedida,
     Quantidade = g.Sum(c => c.Quantidade),
     ValorTotal = g.Sum(c => c.ValorTotal)
   })
         .OrderByDescending(x => x.Quantidade)
          .Take(5)
   .ToList();

  <div class="list-group">
  @foreach (var item in topComprados)
   {
   <div class="list-group-item">
 <div class="d-flex justify-content-between align-items-center">
  <div>
    <strong>@item.Nome</strong><br />
               <small class="text-muted">@item.Quantidade.ToString("F2") @item.UnidadeMedida</small>
          </div>
     <span class="badge bg-danger">R$ @item.ValorTotal.ToString("F2")</span>
     </div>
         </div>
 }
            </div>
                }
         else
{
      <p class="text-muted text-center">Nenhuma compra no período.</p>
            }
            </div>
      </div>
        </div>
    </div>

    <!-- Últimas Movimentações -->
    <div class="row">
        <div class="col-md-6 mb-4">
     <div class="card">
      <div class="card-header">
         <h5><i class="bi bi-clock-history"></i> Últimas Compras</h5>
      </div>
      <div class="card-body">
            @if (compras != null && compras.Any())
            {
   <div class="table-responsive">
            <table class="table table-sm">
           <thead>
  <tr>
       <th>Data</th>
<th>Metal</th>
                  <th>Fornecedor</th>
        <th class="text-end">Total</th>
    </tr>
               </thead>
     <tbody>
       @foreach (var compra in compras.Take(5))
 {
            <tr>
           <td>@compra.DataCompra.ToString("dd/MM HH:mm")</td>
   <td>@compra.Metal?.Nome</td>
 <td>@compra.NomeFornecedor</td>
    <td class="text-end">R$ @compra.ValorTotal.ToString("F2")</td>
    </tr>
     }
          </tbody>
             </table>
          </div>
          }
        else
   {
         <p class="text-muted text-center">Nenhuma compra recente.</p>
                }
</div>
            </div>
   </div>

     <div class="col-md-6 mb-4">
  <div class="card">
           <div class="card-header">
       <h5><i class="bi bi-clock-history"></i> Últimas Vendas</h5>
    </div>
   <div class="card-body">
     @if (vendas != null && vendas.Any())
   {
              <div class="table-responsive">
     <table class="table table-sm">
      <thead>
       <tr>
        <th>Data</th>
    <th>Metal</th>
       <th>Cliente</th>
         <th class="text-end">Total</th>
         </tr>
         </thead>
    <tbody>
       @foreach (var venda in vendas.Take(5))
 {
    <tr>
          <td>@venda.DataVenda.ToString("dd/MM HH:mm")</td>
       <td>@venda.Metal?.Nome</td>
       <td>@venda.NomeCliente</td>
            <td class="text-end">R$ @venda.ValorTotal.ToString("F2")</td>
   </tr>
     }
        </tbody>
           </table>
      </div>
}
        else
      {
                <p class="text-muted text-center">Nenhuma venda recente.</p>
    }
       </div>
         </div>
     </div>
    </div>
}

@code {
    private bool carregando = true;
    
  private DateTime dataInicio = DateTime.Now.AddDays(-30);
    private DateTime dataFim = DateTime.Now;
    
    private decimal totalVendas;
 private decimal totalCompras;
    private decimal lucroBruto;
    private decimal margemLucro;
    private decimal valorEstoque;
    private int quantidadeVendas;
    private int quantidadeCompras;
    private int quantidadeItensEstoque;
    private int itensEstoqueBaixo;
    
    private List<Compra>? compras;
    private List<Venda>? vendas;
    private List<EstoqueAtual>? estoque;

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    private async Task CarregarDados()
{
 carregando = true;
  
        // Carregar dados do período
        compras = await Database.GetComprasAsync(dataInicio, dataFim);
 vendas = await Database.GetVendasAsync(dataInicio, dataFim);
        estoque = await Database.GetEstoqueAtualAsync();

    // Calcular totais
totalCompras = compras?.Sum(c => c.ValorTotal) ?? 0;
totalVendas = vendas?.Sum(v => v.ValorTotal) ?? 0;
        lucroBruto = totalVendas - totalCompras;
        margemLucro = totalCompras > 0 ? (lucroBruto / totalCompras) * 100 : 0;
 
     quantidadeCompras = compras?.Count ?? 0;
        quantidadeVendas = vendas?.Count ?? 0;
     
        // Calcular estoque
        valorEstoque = estoque?.Sum(e => e.ValorEstoque) ?? 0;
        quantidadeItensEstoque = estoque?.Count ?? 0;
        itensEstoqueBaixo = estoque?.Count(e => e.AbaixoMinimo) ?? 0;
        
carregando = false;
    }
}
