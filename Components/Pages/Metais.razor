@page "/metais"
@using Controle_Roncatin.Models
@using Controle_Roncatin.Services
@inject DatabaseService Database

<h3><i class="bi bi-bezier"></i> Cadastro de Metais</h3>

<div class="row mt-4">
    <div class="col-md-4">
     <div class="card">
<div class="card-header">
          <h5>@(metalSelecionado?.Id > 0 ? "Editar Metal" : "Novo Metal")</h5>
            </div>
  <div class="card-body">
       <EditForm Model="metalSelecionado" OnValidSubmit="SalvarMetal">
     <DataAnnotationsValidator />
 
          <div class="mb-3">
   <label class="form-label">Nome do Metal *</label>
    <InputText class="form-control" @bind-Value="metalSelecionado!.Nome" placeholder="Ex: Alumínio" />
             </div>

         <div class="mb-3">
   <label class="form-label">Descrição</label>
      <InputTextArea class="form-control" @bind-Value="metalSelecionado!.Descricao" rows="2" placeholder="Ex: Latas, perfis, chapas" />
              </div>

    <div class="mb-3">
       <label class="form-label">Unidade de Medida *</label>
    <InputSelect class="form-control" @bind-Value="metalSelecionado!.UnidadeMedida">
<option value="KG">Quilograma (KG)</option>
                  <option value="TON">Tonelada (TON)</option>
            <option value="UN">Unidade (UN)</option>
       </InputSelect>
            </div>

     <div class="row">
     <div class="col-md-6 mb-3">
        <label class="form-label">Preço Compra (R$) *</label>
      <InputNumber class="form-control" @bind-Value="metalSelecionado!.PrecoCompra" step="0.01" />
             </div>
 <div class="col-md-6 mb-3">
   <label class="form-label">Preço Venda (R$) *</label>
   <InputNumber class="form-control" @bind-Value="metalSelecionado!.PrecoVenda" step="0.01" />
              </div>
     </div>

           <div class="mb-3">
        <label class="form-label">Estoque Mínimo</label>
           <InputNumber class="form-control" @bind-Value="metalSelecionado!.EstoqueMinimo" step="0.01" />
          </div>

         <div class="mb-3 form-check">
    <InputCheckbox class="form-check-input" @bind-Value="metalSelecionado!.Ativo" id="ativoCheck" />
         <label class="form-check-label" for="ativoCheck">Ativo</label>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
         <i class="bi bi-save"></i> Salvar
     </button>
 @if (metalSelecionado?.Id > 0)
   {
                 <button type="button" class="btn btn-secondary" @onclick="NovoMetal">
           <i class="bi bi-plus-circle"></i> Novo
        </button>
                 }
                    </div>
       </EditForm>
            </div>
        </div>

    @if (metalSelecionado?.Id > 0)
        {
            <div class="card mt-3">
     <div class="card-body">
   <h6>Análise de Lucro</h6>
              <p class="mb-1">
            <strong>Margem:</strong> 
         <span class="badge @(metalSelecionado.MargemLucro > 0 ? "bg-success" : "bg-danger")">
   @metalSelecionado.MargemLucro.ToString("F2")%
              </span>
     </p>
      <p class="mb-0">
        <strong>Lucro Unitário:</strong> 
         R$ @metalSelecionado.LucroUnitario.ToString("F2")
       </p>
    </div>
  </div>
        }
    </div>

    <div class="col-md-8">
 <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
   <h5>Metais Ativos</h5>
   <button class="btn btn-sm btn-primary" @onclick="CarregarMetais">
      <i class="bi bi-arrow-clockwise"></i>
       </button>
       </div>
   <div class="card-body">
   @if (metais == null)
                {
             <p class="text-center"><em>Carregando...</em></p>
     }
else if (!metais.Any())
        {
       <p class="text-center text-muted">Nenhum metal cadastrado.</p>
        }
             else
    {
      <div class="table-responsive">
        <table class="table table-hover">
 <thead>
      <tr>
         <th>Nome</th>
    <th>Descrição</th>
             <th>Unidade</th>
         <th class="text-end">Preço Compra</th>
       <th class="text-end">Preço Venda</th>
           <th class="text-end">Margem</th>
              <th>Status</th>
           <th class="text-center">Ações</th>
         </tr>
     </thead>
         <tbody>
   @foreach (var metal in metais)
  {
 <tr class="@(metal.Id == metalSelecionado?.Id ? "table-active" : "")">
           <td><strong>@metal.Nome</strong></td>
  <td>@metal.Descricao</td>
  <td>@metal.UnidadeMedida</td>
     <td class="text-end">R$ @metal.PrecoCompra.ToString("F2")</td>
         <td class="text-end">R$ @metal.PrecoVenda.ToString("F2")</td>
          <td class="text-end">
        <span class="badge @(metal.MargemLucro > 0 ? "bg-success" : "bg-danger")">
    @metal.MargemLucro.ToString("F2")%
           </span>
  </td>
             <td>
      <span class="badge @(metal.Ativo ? "bg-success" : "bg-secondary")">
         @(metal.Ativo ? "Ativo" : "Inativo")
        </span>
  </td>
    <td class="text-center">
            <button class="btn btn-sm btn-outline-primary" @onclick="() => EditarMetal(metal)">
      <i class="bi bi-pencil"></i>
                  </button>
         <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => DesativarMetal(metal)">
   <i class="bi bi-trash"></i>
   </button>
              </td>
       </tr>
     }
      </tbody>
             </table>
         </div>
  }
   </div>
        </div>
    </div>
</div>

@code {
    private List<Metal>? metais;
    private Metal? metalSelecionado = new Metal();

    protected override async Task OnInitializedAsync()
    {
        await CarregarMetais();
    }

    private async Task CarregarMetais()
    {
        metais = await Database.GetMetaisAsync();
    }

    private async Task SalvarMetal()
    {
   if (metalSelecionado != null)
        {
await Database.SaveMetalAsync(metalSelecionado);
  await CarregarMetais();
     NovoMetal();
        }
    }

    private void EditarMetal(Metal metal)
    {
        metalSelecionado = new Metal
        {
    Id = metal.Id,
            Nome = metal.Nome,
            Descricao = metal.Descricao,
       UnidadeMedida = metal.UnidadeMedida,
        PrecoCompra = metal.PrecoCompra,
     PrecoVenda = metal.PrecoVenda,
         EstoqueMinimo = metal.EstoqueMinimo,
  Ativo = metal.Ativo,
      DataCadastro = metal.DataCadastro
 };
    }

    private async Task DesativarMetal(Metal metal)
    {
        if (metal != null)
     {
      await Database.DeleteMetalAsync(metal);
     await CarregarMetais();
            NovoMetal();
        }
    }

 private void NovoMetal()
    {
  metalSelecionado = new Metal();
  }
}
